<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>

# 交易结构

一笔普通交易的数据结构如下所示：

| 字段        | 类型    | 说明                              |
|--------------|---------|------------------------------------------|
| `version`    | byte   | 交易版本号，目前为0                    |
| `nonce`    | uint   | 随机数                   |
| `validUntilBlock`    | uint   |  交易的有效期                |
| `sender`    | UInt160   | 发送方的地址脚本哈希                    |
| `systemFee`    | long   | 交易在虚拟机中执行消耗的资源费用     |
| `networkFee`    | long   | 用户向Neo网络提交交易时支付的费用     |
| `attributes` | tx_attr[]   | 交易所具备的额外特性  |
| `script`     | byte[]   | 交易的合约脚本 |
| `witnesses`  | Witness[]   | 用于验证交易的脚本列表    |

## version
version属性允许对交易结构进行更新，使其具有向后兼容性。 目前版本为0。
## sender
由于NEO3弃用了UTXO模型，仅保留有账户余额模型。原生资产NEO和GAS的转账交易统一为NEP-5资产操作方式，因此交易结构中不再记录inputs和outputs字段，通过sender字段来跟踪交易的发送方。该字段是钱包中交易发起账户的脚本哈希值。
## systemFee
系统费用是根据NeoVM要执行的指令计算得出的固定费用。一般来说，交易对网络资源的需求越大，交易的成本就越高。NEO3取消了每笔交易10 GAS的免费额度，系统费用总额受合约脚本的指令数量和指令类型影响。计算公式如下所示：
$$
SystemFee=\sum_{i\in OpcodeSet}OpcodePrice_{i}*n_{i}
$$


$$SystemFee=\sum_{i\in OpcodeSet}OpcodePrice_{i}*n_{i}$$

其中，OpcodeSet为指令集，为第i种指令的费用，为第i种指令在合约脚本中的个数。

## networkFee
网络费是用户向Neo网络提交交易时支付的费用，作为共识节点的出块奖励。每个交易的网络费存在一个最小值，计算公式如下所示：

 $$ NetworkFee = VerificationCost + tx.Length * FeePerByte $$

其中，VerificationCost为虚拟机验证交易签名消耗的费用，tx.Length为交易数据的字节长度，FeePerByte为交易每字节的费用。用户支付的网络费需要大于或等于此最小值，否则交易无法通过验证。

## attributes

根据具体的交易类型允许向交易添加额外的属性。 对于每个属性，必须指定使用类型，以及外部数据和外部数据的大小。

| 字段| 类型| 说明|
|----------|-------|---------------------------------------|
| `usage`  | uint8 | 属性使用类型                  |
| `data`   | byte[] |   交易待校验脚本   |

### 属性使用类型

以下使用类型可以包括在交易的属性中。

| 值    | 名称| 说明| 类型|
|---------------|-------------------|---------------------------------------|-----------------------------------------|
| `0x20`           | `Cosigner`    |  签名验证          | `byte`   |
| `0x81`           | `Url`          | 外部介绍信息地址    | `byte`       

每个交易最多可以添加16个属性。

## script
虚拟机所执行的合约脚本。
## witnesses
witnesses属性用于验证交易的有效性和完整性。 数组中的对象通常被称为`见证人`，每个见证人都有两个属性。

| 字段 | 说明|
|----------------------|---------------------------------------------------------------------------------------------|
| `InvocationScript`   | 调用脚本，向验证脚本传递参数                   |
| `VerificationScript` |验证脚本   |

 可以为每个交易添加多个见证人，也可以使用具有多方签名的见证人。

#### 调用脚本

调用脚本可以通过以下步骤进行构造：

1.	`0x40`（PUSHBYTES64）后跟64字节长的签名

通过重复这些步骤，调用脚本可以为多方签名合约推送多个签名。

#### 验证脚本

具有单个签名的验证脚本可以通过以下步骤进行构建：

1. `0x21`（PUSHBYTES33）后跟33字节长的与签名相对应的公钥
2. `0xAC`（CHECKSIG）用所提供的公钥对签名进行验证

多方签名合约的验证脚本可以通过以下步骤进行构建：

1. `0x52`（PUSH2）到`0x60`（PUSH16）表示所需的签名数量
2. `0x21`（PUSHBYTES33）后跟多方签名合约的第一个33字节长的公钥，对多方签名合约中的每个公钥重复执行这个步骤
3. `0x52`（PUSH2）到`0x60`（PUSH16）表示签名的公钥总数
4. `0xAE`（CHECKMULTISIG）用所提供的公钥对签名进行验证

为了保证性能，在验证多方签名合约时，公钥和签名的顺序必须保持一致。